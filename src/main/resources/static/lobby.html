<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>로비</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="./css/lobby.css">
</head>
<body>

    <header style="background: white; border-bottom: 1px solid #ddd;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;">
            <a href="index.html" style="font-weight: bold; font-size: 1.2rem; color: #00664F;">Ctrl+Z : QUIZ SESSION</a>
            <div>
                <span id="header-user-name" style="font-weight:bold; margin-right:10px;"></span>
                <button onclick="logout()" style="padding: 5px 10px; cursor: pointer;">로그아웃</button>
            </div>
        </div>
    </header>

    <main class="main-layout">
        
        <aside class="sidebar">
            <div id="user-section">
                <div class="profile-section">
                    <div class="profile-img">
                        <i class="fa fa-user"></i>
                    </div>
                    <div class="user-name" id="profile-nickname">로딩중...</div>
                    <div class="user-rank">Gold Tier</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">누적 점수</span>
                        <span class="stat-value" id="profile-score">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">랭킹</span>
                        <!-- ✅ 수정: id="profile-rank" 추가 -->
                        <span class="stat-value" id="profile-rank"># --</span>
                    </div>
                </div>

                <button class="create-room-btn" onclick="tryCreateRoom()">
                    <i class="fa fa-plus"></i> 방 만들기
                </button>
            </div>
        </aside>

        <section class="content-area">
            <div class="section-header">
                <h2 class="section-title">진행 중인 퀴즈 방</h2>
                <span style="color:#666; font-size:0.9rem;">실시간 업데이트 중</span>
            </div>
            <div class="room-grid" id="room-container"></div>
            <div id="empty-message" class="empty-room hidden">
                <i class="fa fa-inbox" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>현재 생성된 방이 없습니다.<br>첫 번째 방을 만들어보세요!</p>
            </div>
        </section>
    </main>
    
    <div id="createRoomModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:1000;">
    <h3>방 만들기 설정</h3>
    <label>방 제목: <input type="text" id="mTitle" value="즐거운 퀴즈"></label><br><br>
    <label>문제 수: <input type="number" id="mQCount" value="10"></label><br><br>
    <label>시간제한(초): <input type="number" id="mTime" value="30"></label><br><br>
    <label>최대인원: <input type="number" id="mMax" value="8"></label><br><br>
    <div style="text-align:right;">
        <button onclick="submitCreateRoom()">확인</button>
        <button onclick="closeModal()">취소</button>
    </div>
</div>

<script>
    let socket;

    window.onload = function() {
        const serverIP = sessionStorage.getItem('serverIP');
        const userID = sessionStorage.getItem('userID');
        const nickname = sessionStorage.getItem('nickname');

        if (!serverIP || !userID) {
            alert("로그인이 필요합니다.");
            location.href = 'index.html';
            return;
        }

        // 1. 기본 정보 세팅
        document.getElementById('profile-nickname').innerText = nickname || userID;
        document.getElementById('header-user-name').innerText = nickname + "님";

        // 2. 서버에서 내 최신 점수 및 랭킹 가져오기 (비동기)
        fetchUserInfo(serverIP);

        // 3. 웹소켓 연결
        connectLobbySocket(serverIP);
    };

    // ✅ 서버 API (/me, /myrank) 호출하여 점수와 랭킹 업데이트
    async function fetchUserInfo(ip) {
        try {
            // (1) 점수 가져오기 (/me)
            const userRes = await fetch(`http://${ip}/api/me`, { credentials: 'include' });
            if (userRes.ok) {
                const user = await userRes.json();
                document.getElementById('profile-score').innerText = user.score;
            }

            // (2) 랭킹 가져오기 (/myrank)
            const rankRes = await fetch(`http://${ip}/api/myrank`, { credentials: 'include' });
            if (rankRes.ok) {
                const rank = await rankRes.text(); // 숫자로 옴 (예: "5")
                // -1이면 로그인 안됨, 아니면 등수 표시
                if (rank != -1) {
                    document.getElementById('profile-rank').innerText = "#" + rank;
                }
            }
        } catch (e) {
            console.error("정보 조회 실패:", e);
        }
    }

    function logout() {
        sessionStorage.clear();
        location.href = 'index.html';
    }

    function connectLobbySocket(ip) {
        socket = new WebSocket(`ws://${ip}/ws/lobby`);
        socket.onopen = () => {
            console.log("✅ 로비 웹소켓 연결 성공!");
            socket.send(JSON.stringify({ type: 'REQ_ROOM_LIST' }));
        };
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'ROOM_LIST') {
                updateRoomList(data.rooms); 
            }

        };
        socket.onerror = (err) => console.error("연결 실패:", err);
    }

    function updateRoomList(rooms) {
        const container = document.getElementById('room-container');
        const emptyMsg = document.getElementById('empty-message');
        
        container.innerHTML = '';

        if (!rooms || rooms.length === 0) {
            emptyMsg.classList.remove('hidden');
            return;
        }
        emptyMsg.classList.add('hidden');

        rooms.forEach(room => {
            const statusClass = room.status === 'WAITING' ? 'badge-waiting' : 'badge-playing';
            const statusText = room.status === 'WAITING' ? '대기중' : '게임중';
            
            const cardHtml = `
            <div class="room-card">
                <div class="room-header">
                    <span class="room-title">${room.roomName}</span> 
                    <span class="room-status badge-waiting">${room.state}</span>
                </div>
                <div class="room-body">
                    <div class="host-name">방장: ${room.hostNickname}</div>
                </div>
                <div class="room-footer">
                    <span class="user-count">
                        <i class="fa fa-users"></i> 
                        <span>${room.currentParticipantCount} / ${room.maxParticipants}</span>
                    </span>
                    <button class="join-btn" onclick="enterRoom(${room.roomId})">참여</button>
                </div>
            </div>
        `;
            container.innerHTML += cardHtml;
        });
    }

    // 1. 방 만들기 버튼 클릭 시 모달 열기
    function tryCreateRoom() {
        document.getElementById('createRoomModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('createRoomModal').style.display = 'none';
    }

    // 2. 입력된 정보로 방 생성 요청 보내기
    async function submitCreateRoom() {
        const title = document.getElementById('mTitle').value;
        const qCount = parseInt(document.getElementById('mQCount').value);
        const timeLimit = parseInt(document.getElementById('mTime').value);
        const maxPart = parseInt(document.getElementById('mMax').value);

        if (!title) return alert("방 제목을 입력하세요.");

        const serverIP = sessionStorage.getItem('serverIP'); // 또는 직접 IP 지정

        try {
            const response = await fetch(`http://${serverIP}/api/rooms`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    title: title,
                    questionCount: qCount,
                    timeLimitPerQuestion: timeLimit,
                    maxParticipants: maxPart
                }),
                credentials: 'include'
            });

            if (response.ok) {
                const room = await response.json();
                alert(`방 생성 성공! ID: ${room.roomId}`);
                closeModal();
                enterRoom(room.roomId);
            } else {
                alert("방 생성 실패: " + await response.text());
            }
        } catch (e) {
            console.error(e);
            alert("서버 오류");
        }
    }

    function enterRoom(roomId) {
        location.href = `gameroom.html?roomId=${roomId}`;
    }
</script>
</body>
</html>