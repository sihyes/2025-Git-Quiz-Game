<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì„ë°© - Ctrl+Z</title>
    <link rel="stylesheet" href="./css/gameroom.css">
</head>

<body>

<header>
    <div class="room-title">ğŸ® ë°© ID: <span id="dispRoomId"></span></div>
    <button class="quit-btn" onclick="location.href='lobby.html'">ë‚˜ê°€ê¸°</button>
</header>

<div class="container">
    <!-- 2. ì¢Œì¸¡ ì°¸ê°€ì ëª©ë¡ -->
    <aside class="participant-area">
        <div class="p-title">ğŸ† ì°¸ê°€ì ë­í‚¹ (<span id="p-count">0</span>ëª…)</div>
        <div id="p-list">
            <!-- JSë¡œ ì•„ì´í…œ ì¶”ê°€ -->
        </div>
    </aside>

    <!-- [ì¤‘ì•™] í€´ì¦ˆ í™”ë©´ -->
    <main class="quiz-area">
        <div class="question-box">
            <h3>QUIZ TIME</h3>
            <p class="question-text" id="quizQuestion">
                ì°¸ê°€ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </p>
        </div>
        
        <!-- 3. ê²Œì„ ì‹œì‘ ë²„íŠ¼ -->
        <button id="startBtn" class="start-btn" onclick="sendStartGame()">GAME START</button>
        
        <!-- ì •ë‹µ ì…ë ¥ (ê²Œì„ ì‹œì‘ í›„ ë³´ì„) -->
        <input type="text" id="ansInput" class="answer-input" style="display:none;" placeholder="ì •ë‹µ ì…ë ¥" onkeydown="if(event.key==='Enter') sendAnswer(this)">
    </main>

    <!-- [ìš°ì¸¡] ì±„íŒ… í™”ë©´ -->
    <aside class="chat-area">
        <div id="chatBox"></div>
        <div class="chat-input-row">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter') sendMessage()" />
            <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </aside>
</div>

<script>
    let socket;
    // ì‹¤ì œë¡œëŠ” sessionStorageë‚˜ ì¿ í‚¤ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨. ì„ì‹œë¡œ Guest ì²˜ë¦¬.
    let myName = sessionStorage.getItem('nickname') || 'Guest'; 
    let serverIP = sessionStorage.getItem('serverIP'); // ë¡œë¹„ì—ì„œ ì €ì¥í–ˆë‹¤ê³  ê°€ì •
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ roomId ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');

    document.getElementById('dispRoomId').innerText = roomId;

    window.onload = () => {
        if (!serverIP || !roomId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            // location.href = 'lobby.html'; // ì‹¤ì œ ì ìš© ì‹œ ì£¼ì„ í•´ì œ
            // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë¡œì»¬í˜¸ìŠ¤íŠ¸ ê¸°ë³¸ê°’ ì„¤ì • ê°€ëŠ¥
            if(!serverIP) serverIP = window.location.host; 
        }
        
        // ì›¹ì†Œì¼“ ì—°ê²°
        // ì£¼ì˜: GameWebSocketHandler ë§¤í•‘ ì£¼ì†Œê°€ /ws/game/* ì¸ì§€ í™•ì¸ í•„ìš”
        socket = new WebSocket(`ws://${serverIP}/ws/game/${roomId}`);
        setupWebSocketListeners();
    };

    function setupWebSocketListeners() {
        socket.onopen = () => {
            console.log("ğŸ® ê²Œì„ ì„œë²„ ì—°ê²°ë¨");
            // ì…ì¥ ë©”ì‹œì§€ ì „ì†¡ -> GameWebSocketHandlerì˜ handleJoin íŠ¸ë¦¬ê±°
            socket.send(JSON.stringify({ type: 'JOIN', sender: myName, roomId: roomId }));
        };

        socket.onmessage = function (event){
            const data = JSON.parse(event.data);

            if (data.type === 'CHAT') {
                displayMessage(data);
            } else if (data.type === 'ROOM_UPDATE') { 
        		// â˜… ì„œë²„ì—ì„œ 'ROOM_UPDATE' íƒ€ì…ìœ¼ë¡œ ì°¸ê°€ì ëª©ë¡ì„ ë³´ë‚¸ë‹¤ê³  ê°€ì •
       		 	updateParticipants(data.participants);
   			 }
            else if (data.type === 'PARTICIPANT_LIST') {
                // 2. ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ì ìˆ˜ìˆœ ì •ë ¬í•´ì„œ ì¤Œ)
                updateParticipants(data.participants);
            } else if (data.type === 'START') {
                // 3. ê²Œì„ ì‹œì‘ ì²˜ë¦¬
                alert("ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!");
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('ansInput').style.display = 'block';
                document.getElementById('quizQuestion').innerText = "ë¬¸ì œê°€ ê³§ ì¶œì œë©ë‹ˆë‹¤!";
            }
        };
    }

function updateParticipants(participants) {
    // 1. ë°ì´í„° í™•ì¸ (nullì´ë©´ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬)
    if (!participants) participants = [];

    // 2. ë¦¬ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°ˆ ì˜ì—­ ì°¾ê¸°
    let listContainer = document.getElementById('p-list');
    const wrapper = document.querySelector('.participant-area');

    // â˜… [í•µì‹¬] ë§Œì•½ p-list íƒœê·¸ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤ (ë³µêµ¬ ë¡œì§)
    if (!listContainer) {
        if (wrapper) {
            // ì œëª©(p-title)ì€ ê±´ë“œë¦¬ì§€ ì•Šê³  ë’¤ì— ì¶”ê°€
            listContainer = document.createElement('div');
            listContainer.id = 'p-list';
            wrapper.appendChild(listContainer);
        } else {
            console.error("ì˜¤ë¥˜: .participant-area íƒœê·¸ë„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
    }

    // 3. ì¤‘ë³µ ì œê±° (ë‹‰ë„¤ì„ ê¸°ì¤€)
    const uniqueParticipants = [];
    const names = new Set();
    participants.forEach(p => {
        // ë‹‰ë„¤ì„ì´ ìˆê³ , ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ë§Œ ì¶”ê°€
        if (p.nickname && !names.has(p.nickname)) {
            names.add(p.nickname);
            uniqueParticipants.push(p);
        }
    });

    // 4. ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸
    const countSpan = document.getElementById('p-count');
    if (countSpan) countSpan.innerText = uniqueParticipants.length;

    // 5. í™”ë©´ ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    listContainer.innerHTML = '';
    
    // ì ìˆ˜ìˆœ ì •ë ¬
    uniqueParticipants.sort((a, b) => b.score - a.score);

    uniqueParticipants.forEach(p => {
        const isMe = (p.nickname === myName);
        const div = document.createElement('div');
        
        // ìŠ¤íƒ€ì¼ ì ìš©
        div.style.padding = "10px";
        div.style.borderBottom = "1px solid #46627f";
        div.style.marginBottom = "5px";
        
        if (isMe) {
            div.style.backgroundColor = "rgba(241, 196, 15, 0.1)"; 
            div.style.borderLeft = "3px solid #f1c40f";
        }

        div.innerHTML = `
            <div style="font-weight: ${isMe ? 'bold' : 'normal'}; color: ${isMe ? '#f1c40f' : '#ecf0f1'};">
                ${p.nickname} ${isMe ? '(ë‚˜)' : ''}
            </div>
            <div style="font-size: 0.85rem; color: #bdc3c7;">
                Score: ${p.score}
            </div>
        `;
        listContainer.appendChild(div);
    });
}

    function displayMessage(msg) {
        const chatBox = document.getElementById("chatBox");
        
        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ì…ì¥ ì•Œë¦¼ ë“±)
        if (msg.sender === '[ì•Œë¦¼]') {
            chatBox.innerHTML += `<div class="system-msg"><span class="system-badge">${msg.text}</span></div>`;
        } else {
            const isMe = msg.sender === myName;
            const cls = isMe ? "me" : "you";
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const nameHtml = isMe ? '' : `<span class="sender-name">${msg.sender}</span>`;

            chatBox.innerHTML += `
                <div style="clear:both;">
                    <div class="message ${cls}">
                        ${nameHtml}
                        <div>${msg.text}</div>
                        <small style="font-size:0.7rem; color:#ccc;">${time}</small>
                    </div>
                </div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const msg = input.value;
        if (msg.trim() === "") return;

        socket.send(JSON.stringify({ type: 'CHAT', sender: myName, text: msg, roomId: roomId }));
        input.value = '';
    }

    // 3. ê²Œì„ ì‹œì‘ ìš”ì²­ ë³´ë‚´ê¸°
    function sendStartGame() {
        // GameWebSocketHandlerì—ì„œ START íƒ€ì… ì²˜ë¦¬ ë¡œì§ í•„ìš”
        socket.send(JSON.stringify({ type: 'START', sender: myName, roomId: roomId }));
    }

    function sendAnswer(inputElement) {
        const answer = inputElement.value;
        if(!answer) return;
        
        // ì •ë‹µ ì œì¶œ ë¡œì§ (ì¶”í›„ êµ¬í˜„)
        // socket.send(JSON.stringify({ type: 'ANSWER', ... }));
        
        inputElement.value = ''; 
    }
</script>
</body>
</html>