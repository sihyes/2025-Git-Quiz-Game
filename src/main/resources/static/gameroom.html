<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì„ë°© - Ctrl+Z</title>
    <link rel="stylesheet" href="./css/gameroom.css">
</head>

<body>

<header>
    <div class="room-title">ğŸ® ë°© ID: <span id="dispRoomId"></span></div>
    <div class="timer-display" id="quizTimer">READY</div>
    <button class="quit-btn" onclick="location.href='lobby.html'">ë‚˜ê°€ê¸°</button>
</header>

<div class="container">
    <!-- 2. ì¢Œì¸¡ ì°¸ê°€ì ëª©ë¡ -->
    <aside class="participant-area">
        <div class="p-title">ğŸ† ì°¸ê°€ì ë­í‚¹ (<span id="p-count">0</span>ëª…)</div>
        <div id="p-list">
            <!-- JSë¡œ ì•„ì´í…œ ì¶”ê°€ -->
        </div>
    </aside>

    <!-- [ì¤‘ì•™] í€´ì¦ˆ í™”ë©´ -->
    <main class="quiz-area">
        <div class="question-box">
            <h3>QUIZ TIME</h3>
            <p class="question-text" id="quizQuestion">
                ì°¸ê°€ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </p>
        </div>

        <!-- 3. ê²Œì„ ì‹œì‘ ë²„íŠ¼ -->
        <button id="startBtn" class="start-btn" onclick="sendStartGame()">GAME START</button>

        <!-- ì •ë‹µ ì…ë ¥ (ê²Œì„ ì‹œì‘ í›„ ë³´ì„) -->
        <input type="text" id="ansInput" class="answer-input" style="display:none;" placeholder="ì •ë‹µ ì…ë ¥" onkeydown="if(event.key==='Enter') sendAnswer(this)">
    </main>

    <!-- [ìš°ì¸¡] ì±„íŒ… í™”ë©´ -->
    <aside class="chat-area">
        <div id="chatBox"></div>
        <div class="chat-input-row">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter') sendMessage()" />
            <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </aside>
</div>

<script>
    let socket;
    // ì‹¤ì œë¡œëŠ” sessionStorageë‚˜ ì¿ í‚¤ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨. ì„ì‹œë¡œ Guest ì²˜ë¦¬.
    let myName = sessionStorage.getItem('nickname') || 'Guest';
    let serverIP = sessionStorage.getItem('serverIP'); // ë¡œë¹„ì—ì„œ ì €ì¥í–ˆë‹¤ê³  ê°€ì •

    // URL íŒŒë¼ë¯¸í„°ì—ì„œ roomId ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');

    document.getElementById('dispRoomId').innerText = roomId;

    // âœ¨ ê²Œì„ ìƒíƒœ ë° íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€
    let currentTimer; // setInterval IDë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let timeLeft = 0; // ë‚¨ì€ ì‹œê°„ (ì´ˆ)
    let questionLimit = 5; // â˜… ê¸°ë³¸ê°’: ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°
    let currentQuestionIndex = 0;
    let questionDuration = 10; // â˜… ê¸°ë³¸ê°’: ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°

    // â˜… ì‹œë®¬ë ˆì´ì…˜: ë¬¸ì œ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ë°›ì•„ì™€ì•¼ í•¨)
    const questionData = [
        { text: "1. ì´ ê²Œì„ì˜ ì œëª©ì€ ë¬´ì—‡ì¸ê°€ìš”? (Ctrl+Z)", answer: "Ctrl+Z" },
        { text: "2. í˜„ì¬ ì›¹ í˜ì´ì§€ì˜ ì–¸ì–´ ì½”ë“œëŠ” ë¬´ì—‡ì¸ê°€ìš”? (ko)", answer: "ko" },
        { text: "3. 10 + 20 ì€?", answer: "30" },
        { text: "4. ë‹¤ìŒìœ¼ë¡œ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìƒ‰ê¹”ì€? (íŒŒë€ìƒ‰)", answer: "íŒŒë€ìƒ‰" },
        { text: "5. ë§ˆì§€ë§‰ ë¬¸ì œì…ë‹ˆë‹¤. í™”ì´íŒ…!", answer: "í™”ì´íŒ…" }
    ];

    // ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ì°¸ê°€ì ëª©ë¡ ì´ˆê¸°í™” (ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©)
    function getInitialParticipants() {
        let stored = sessionStorage.getItem('participants');
        if (stored) return JSON.parse(stored);

        return [{ nickname: myName, score: 0 }];
    }

    // âœ¨ window.onload í•¨ìˆ˜ë¥¼ asyncë¡œ ë³€ê²½í•˜ì—¬ ë°© ì •ë³´ ë¡œë”©ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
    window.onload = async () => {
        if (!serverIP || !roomId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            if(!serverIP) serverIP = window.location.host;
        }

        // ì´ˆê¸° ì°¸ê°€ì ëª©ë¡ ë¡œë“œ ë° í™”ë©´ í‘œì‹œ (ì‹œë®¬ë ˆì´ì…˜)
        updateParticipants(getInitialParticipants());

        // â˜… ë°© ì •ë³´ ë¡œë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
        await fetchRoomInfo(serverIP, roomId);

        // ì›¹ì†Œì¼“ ì—°ê²° (ë°© ì •ë³´ ë¡œë“œ í›„ ì‹œì‘)
        socket = new WebSocket(`ws://${serverIP}/ws/game/${roomId}`);
        setupWebSocketListeners();
    };

    // âœ¨ ì„œë²„ì—ì„œ ë°© ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function fetchRoomInfo(ip, roomId) {
    try {
        const res = await fetch(`http://${ip}/api/rooms/${roomId}`);

        if (res.ok) {
            const roomInfo = await res.json();

            // âœ¨ ì„œë²„ì—ì„œ ë°›ì€ ì‹œê°„ ì œí•œì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            questionDuration = roomInfo.timeLimitPerQuestion;
            questionLimit = roomInfo.questionCount; // ë¬¸ì œ ìˆ˜ë„ ë°˜ì˜

            console.log(`âœ… ë°© ì„¤ì • ë¡œë“œ ì™„ë£Œ: ì‹œê°„ ì œí•œ ${questionDuration}ì´ˆ, ë¬¸ì œ ìˆ˜ ${questionLimit}ê°œ`);
            // â˜… ì„±ê³µ ì‹œ alert ì¶”ê°€:
            alert(`ë°© ì„¤ì • ë¡œë“œ ì„±ê³µ! ë¬¸ì œë‹¹ ì œí•œ ì‹œê°„: ${questionDuration}ì´ˆ`);
        } else {
            // â˜… ì‹¤íŒ¨ ì‹œ alert ì¶”ê°€:
            alert(`ë°© ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ì„œë²„ ì‘ë‹µ ì½”ë“œ ${res.status}. ê¸°ë³¸ê°’(10ì´ˆ) ì‚¬ìš©.`);
            console.error(`ë°© ì„¤ì • ë¡œë“œ ì‹¤íŒ¨. ìƒíƒœ: ${res.status}`);
        }
    } catch (e) {
        // â˜… ì˜¤ë¥˜ ë°œìƒ ì‹œ alert ì¶”ê°€:
        alert("ë°© ì •ë³´ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ê¸°ë³¸ê°’(10ì´ˆ) ì‚¬ìš©.");
        console.error("ë°© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", e);
    }
}

    function setupWebSocketListeners() {
        socket.onopen = () => {
            console.log("ğŸ® ê²Œì„ ì„œë²„ ì—°ê²°ë¨");
            socket.send(JSON.stringify({ type: 'JOIN', sender: myName, roomId: roomId }));
        };

        socket.onmessage = function (event){
            const data = JSON.parse(event.data);

            if (data.type === 'CHAT') {
                displayMessage(data);
            } else if (data.type === 'ROOM_UPDATE' || data.type === 'PARTICIPANT_LIST') {
                // ì„œë²„ì—ì„œ ë°›ì€ ì°¸ê°€ì ëª©ë¡ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                updateParticipants(data.participants);
            } else if (data.type === 'START') {
                // 3. ê²Œì„ ì‹œì‘ ì²˜ë¦¬
                alert("ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! 10ì´ˆ í›„ ì²« ë¬¸ì œê°€ ì¶œì œë©ë‹ˆë‹¤.");
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('ansInput').style.display = 'block';
                document.getElementById('quizQuestion').innerText = "ë¬¸ì œê°€ ê³§ ì¶œì œë©ë‹ˆë‹¤! (10ì´ˆ ëŒ€ê¸°)";

                // âœ¨ 10ì´ˆ ëŒ€ê¸° íƒ€ì´ë¨¸ ì‹œì‘ (ì¢…ë£Œ ì‹œ startFirstQuestion í˜¸ì¶œ)
                document.getElementById('quizTimer').innerText = "10";
                document.getElementById('quizTimer').style.color = 'white'; // ëŒ€ê¸° íƒ€ì´ë¨¸ ìƒ‰ìƒ
                startTimerDisplay(10, startFirstQuestion);
            }
        };
    }

// âœ¨ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ê³  í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ì½œë°± ì¶”ê°€)
function startTimerDisplay(durationSeconds, onTimerEnd) {
    if (currentTimer) {
        clearInterval(currentTimer);
    }

    timeLeft = durationSeconds;
    const timerElement = document.getElementById('quizTimer');

    // ë¬¸ì œ ì‹œê°„ì¼ ê²½ìš° íƒ€ì´ë¨¸ ìƒ‰ìƒ ë³€ê²½
    if(onTimerEnd === proceedToNextStep) {
        timerElement.style.color = '#f1c40f'; // ë¬¸ì œ ì œí•œ ì‹œê°„ íƒ€ì´ë¨¸ ìƒ‰ìƒ
    }

    currentTimer = setInterval(() => {
        timerElement.innerText = timeLeft > 0 ? timeLeft : 0;

        if (timeLeft <= 0) {
            clearInterval(currentTimer);
            currentTimer = null;
            onTimerEnd(); // â˜… íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
            return;
        }

        timeLeft--;
    }, 1000);
}

// 10ì´ˆ ëŒ€ê¸° íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ í˜¸ì¶œë˜ì–´ ì²« ë²ˆì§¸ ë¬¸ì œë¥¼ ì‹œì‘
function startFirstQuestion() {
    document.getElementById('quizTimer').innerText = "START";
    currentQuestionIndex = 1;
    startQuestion(currentQuestionIndex);
}

// ë¬¸ì œ íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ (ë‹¤ìŒ ë¬¸ì œ ë˜ëŠ” ê²Œì„ ì¢…ë£Œ)
function proceedToNextStep() {
    // í˜„ì¬ ë¬¸ì œê°€ ë§ˆì§€ë§‰ ë¬¸ì œì¸ì§€ í™•ì¸
    if (currentQuestionIndex >= questionLimit) {
        endGame();
        return;
    }

    // ë‹¤ìŒ ë¬¸ì œ ì‹œì‘
    currentQuestionIndex++;
    startQuestion(currentQuestionIndex);
}

// íŠ¹ì • ë¬¸ì œë¥¼ í™”ë©´ì— í‘œì‹œí•˜ê³  ë¬¸ì œ ì œí•œ íƒ€ì´ë¨¸ ì‹œì‘
function startQuestion(index) {
    const question = questionData[index - 1];
    const quizQuestionElement = document.getElementById('quizQuestion');

    // ë¬¸ì œ í‘œì‹œ
    quizQuestionElement.innerHTML = `[${index}/${questionLimit}] ${question.text}`;

    // ë¬¸ì œë‹¹ ì œí•œ ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘ (ì¢…ë£Œ ì‹œ proceedToNextStep í˜¸ì¶œ)
    // â˜… questionDuration ë³€ìˆ˜ê°€ 30ì´ˆë¡œ ì—…ë°ì´íŠ¸ë˜ì–´ ë°˜ì˜ë©ë‹ˆë‹¤.
    startTimerDisplay(questionDuration, proceedToNextStep);
}

// ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ ë° result.htmlë¡œ ì´ë™
function endGame() {
    document.getElementById('quizTimer').innerText = "END";
    document.getElementById('quizQuestion').innerHTML = "<h2>GAME OVER</h2>ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì ì‹œ í›„ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.";
    document.getElementById('ansInput').style.display = 'none';

    // 3ì´ˆ í›„ result.htmlë¡œ ì´ë™
    setTimeout(() => {
        location.href = 'result.html';
    }, 3000);
}


function updateParticipants(participants) {
    // 1. ë°ì´í„° í™•ì¸ (ì—†ìœ¼ë©´ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì‚¬ìš©)
    if (!participants || participants.length === 0) {
        participants = getInitialParticipants();
    }

    // 2. í˜„ì¬ ìƒíƒœë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì‹œë®¬ë ˆì´ì…˜ ëª©ì )
    sessionStorage.setItem('participants', JSON.stringify(participants));

    // 3. ë¦¬ìŠ¤íŠ¸ ì˜ì—­ ì°¾ê¸°
    let listContainer = document.getElementById('p-list');
    const wrapper = document.querySelector('.participant-area');

    if (!listContainer) {
        if (wrapper) {
            listContainer = document.createElement('div');
            listContainer.id = 'p-list';
            wrapper.appendChild(listContainer);
        } else {
            console.error("ì˜¤ë¥˜: .participant-area íƒœê·¸ë„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
    }

    // 4. ì¤‘ë³µ ì œê±° ë° ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸
    const uniqueParticipants = [];
    const names = new Set();
    participants.forEach(p => {
        if (p.nickname && !names.has(p.nickname)) {
            names.add(p.nickname);
            uniqueParticipants.push(p);
        }
    });

    const countSpan = document.getElementById('p-count');
    if (countSpan) countSpan.innerText = uniqueParticipants.length;

    // 5. í™”ë©´ ì´ˆê¸°í™” ë° ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì ìˆ˜ìˆœ ì •ë ¬)
    listContainer.innerHTML = '';
    uniqueParticipants.sort((a, b) => b.score - a.score);

    uniqueParticipants.forEach(p => {
        const isMe = (p.nickname === myName);
        const div = document.createElement('div');

        div.style.padding = "10px";
        div.style.borderBottom = "1px solid #46627f";
        div.style.marginBottom = "5px";

        if (isMe) {
            div.style.backgroundColor = "rgba(241, 196, 15, 0.1)";
            div.style.borderLeft = "3px solid #f1c40f";
        }

        div.innerHTML = `
            <div style="font-weight: ${isMe ? 'bold' : 'normal'}; color: ${isMe ? '#f1c40f' : '#ecf0f1'};">
                ${p.nickname} ${isMe ? '(ë‚˜)' : ''}
            </div>
            <div id="score-${p.nickname}" style="font-size: 0.85rem; color: #bdc3c7;">
                Score: ${p.score}
            </div>
        `;
        listContainer.appendChild(div);
    });
}

    function displayMessage(msg) {
        const chatBox = document.getElementById("chatBox");

        if (msg.sender === '[ì•Œë¦¼]') {
            chatBox.innerHTML += `<div class="system-msg"><span class="system-badge">${msg.text}</span></div>`;
        } else {
            const isMe = msg.sender === myName;
            const cls = isMe ? "me" : "you";
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const nameHtml = isMe ? '' : `<span class="sender-name">${msg.sender}</span>`;

            chatBox.innerHTML += `
                <div style="clear:both;">
                    <div class="message ${cls}">
                        ${nameHtml}
                        <div>${msg.text}</div>
                        <small style="font-size:0.7rem; color:#ccc;">${time}</small>
                    </div>
                </div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const msg = input.value;
        if (msg.trim() === "") return;

        socket.send(JSON.stringify({ type: 'CHAT', sender: myName, text: msg, roomId: roomId }));
        input.value = '';
    }

    // 3. ê²Œì„ ì‹œì‘ ìš”ì²­ ë³´ë‚´ê¸°
    function sendStartGame() {
        socket.send(JSON.stringify({ type: 'START', sender: myName, roomId: roomId }));
    }

    // âœ¨ ì •ë‹µ ì…ë ¥ ë° ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜
    function sendAnswer(inputElement) {
        const answer = inputElement.value.trim();
        if(!answer) return;

        // í˜„ì¬ ë¬¸ì œê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ëë‚œ ìƒíƒœë¼ë©´ ë¬´ì‹œ
        if (currentQuestionIndex === 0 || currentQuestionIndex > questionLimit) {
            inputElement.value = '';
            return;
        }

        const currentQuestion = questionData[currentQuestionIndex - 1];
        let scoreChange = 0;
        let isCorrect = false;

        // ì •ë‹µ ì²´í¬ ì‹œë®¬ë ˆì´ì…˜ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
        if (currentQuestion && answer.toLowerCase() === currentQuestion.answer.toLowerCase()) {
            isCorrect = true;
            scoreChange = 100; // 100ì  íšë“ ì‹œë®¬ë ˆì´ì…˜
        }

        if (isCorrect) {
            // â˜… ë¡œì»¬ ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜
            let participants = JSON.parse(sessionStorage.getItem('participants'));
            let myParticipant = participants.find(p => p.nickname === myName);

            if (myParticipant) {
                myParticipant.score = (myParticipant.score || 0) + scoreChange;
            }

            updateParticipants(participants); // í™”ë©´ ì—…ë°ì´íŠ¸

            displayMessage({ sender: '[ì•Œë¦¼]', text: `ì •ë‹µ! (+${scoreChange}ì )` });
        } else {
            displayMessage({ sender: '[ì•Œë¦¼]', text: `ì˜¤ë‹µì…ë‹ˆë‹¤.` });
        }

        // ì„œë²„ì— ANSWER ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤ê³  ê°€ì •
        socket.send(JSON.stringify({ type: 'ANSWER', sender: myName, text: answer, roomId: roomId }));

        inputElement.value = '';
    }
</script>
</body>
</html>