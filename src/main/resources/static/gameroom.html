<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì„ë°© - Ctrl+Z</title>
    <link rel="stylesheet" href="./css/gameroom.css">
</head>

<body>

<header>
    <div class="room-title">ğŸ® ë°© ID: <span id="dispRoomId"></span></div>
    <div class="timer-display" id="quizTimer">READY</div>
    <button class="quit-btn" onclick="location.href='lobby.html'">ë‚˜ê°€ê¸°</button>
</header>

<div class="container">
    <aside class="participant-area">
        <div class="p-title">ğŸ† ì°¸ê°€ì ë­í‚¹ (<span id="p-count">0</span>ëª…)</div>
        <div id="p-list">
        </div>
    </aside>

    <main class="quiz-area">
        <div class="question-box">
            <h3>QUIZ TIME</h3>
            <p class="question-text" id="quizQuestion">
                ì°¸ê°€ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </p>
        </div>

        <button id="startBtn" class="start-btn" onclick="sendStartGame()">GAME START</button>

        <input type="text" id="ansInput" class="answer-input" style="display:none;" placeholder="ì •ë‹µ ì…ë ¥" onkeydown="if(event.key==='Enter') sendAnswer(this)">
    </main>

    <aside class="chat-area">
        <div id="chatBox"></div>
        <div class="chat-input-row">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter') sendMessage()" />
            <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </aside>
</div>

<script>
    let socket;
    let myName = sessionStorage.getItem('nickname') || 'Guest';
    let serverIP = sessionStorage.getItem('serverIP');

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');

    document.getElementById('dispRoomId').innerText = roomId;

    // âœ¨ ì„œë²„ì—ì„œ ë°›ì•„ì˜¬ ë³€ìˆ˜ (í´ë¼ì´ì–¸íŠ¸ê°€ ì•Œê³  ìˆì–´ì•¼ í•  ì„¤ì • ê°’)
    let currentTimer;
    let timeLeft = 0;
    let questionDuration = 10; // ì„œë²„ì—ì„œ ë¡œë“œí•  ê¸°ë³¸ê°’
    let questionLimit = 0; // ì„œë²„ì—ì„œ ë¡œë“œí•  ì´ ë¬¸ì œ ìˆ˜

    // ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ì°¸ê°€ì ëª©ë¡ ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ROOM_UPDATEë¥¼ ë³´ë‚´ì£¼ë¯€ë¡œ ë³´ì¡° ì—­í• )
    function getInitialParticipants() {
        let stored = sessionStorage.getItem('participants');
        if (stored) return JSON.parse(stored);
        return [{ nickname: myName, score: 0 }];
    }

    window.onload = async () => {
        if (!serverIP || !roomId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            if(!serverIP) serverIP = window.location.host;
        }

        updateParticipants(getInitialParticipants());

        // â˜… ì„œë²„ì—ì„œ ë°© ì„¤ì •ì„ ë¡œë“œí•˜ì—¬ questionDurationê³¼ questionLimitì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        await fetchRoomInfo(serverIP, roomId);

        socket = new WebSocket(`ws://${serverIP}/ws/game/${roomId}`);
        setupWebSocketListeners();
    };

    async function fetchRoomInfo(ip, roomId) {
        try {
            const res = await fetch(`http://${ip}/api/rooms/${roomId}`);
            if (res.ok) {
                const roomInfo = await res.json();
                questionDuration = roomInfo.timeLimitPerQuestion;
                questionLimit = roomInfo.questionCount;
                console.log(`âœ… ë°© ì„¤ì • ë¡œë“œ ì™„ë£Œ: ì‹œê°„ ì œí•œ ${questionDuration}ì´ˆ, ë¬¸ì œ ìˆ˜ ${questionLimit}ê°œ`);
            } else {
                console.error(`ë°© ì„¤ì • ë¡œë“œ ì‹¤íŒ¨. ìƒíƒœ: ${res.status}. ê¸°ë³¸ê°’ ì‚¬ìš©.`);
            }
        } catch (e) {
            console.error("ë°© ì •ë³´ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        }
    }

    function setupWebSocketListeners() {
        socket.onopen = () => {
            console.log("ğŸ® ê²Œì„ ì„œë²„ ì—°ê²°ë¨");
            socket.send(JSON.stringify({ type: 'JOIN', sender: myName, roomId: roomId }));
        };

        socket.onmessage = function (event){
            const data = JSON.parse(event.data);

            if (data.type === 'CHAT') {
                displayMessage(data);
            } else if (data.type === 'ROOM_UPDATE' || data.type === 'PARTICIPANT_LIST') {
                // âœ¨ ì„œë²„ì—ì„œ ìµœì‹  ì ìˆ˜ì™€ ë­í‚¹ ì •ë³´ë¥¼ ë°›ì•„ í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
                updateParticipants(data.participants);
            } else if (data.type === 'START') {
                // ê²Œì„ ì‹œì‘
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('ansInput').style.display = 'block';
                document.getElementById('quizQuestion').innerText = "ë¬¸ì œê°€ ê³§ ì¶œì œë©ë‹ˆë‹¤! (10ì´ˆ ëŒ€ê¸°)";

                document.getElementById('quizTimer').innerText = "10";
                document.getElementById('quizTimer').style.color = 'white';
                startTimerDisplay(10, onInitialDelayEnd);
            } else if (data.type === 'QUESTION') { // â­ data.type í•„ë“œë¥¼ ì²´í¬
                document.getElementById('quizTimer').innerText = "GO!";

                // ì„œë²„ ë¬¸ì œ í…ìŠ¤íŠ¸ í‘œì‹œ
                document.getElementById('quizQuestion').innerHTML = data.questionText;

                // â­ [ìˆ˜ì •] DTOì—ì„œ ë°›ì€ timeLimit ê°’ì„ ì‚¬ìš©
                const clientDuration = data.timeLimit || questionDuration;

                // ë¬¸ì œ ì œí•œ ì‹œê°„ íƒ€ì´ë¨¸ ì¬ì‹œì‘
                startTimerDisplay(clientDuration, onQuestionTimerEnd);
            }
            // âœ¨ ì„œë²„ì—ì„œ ë¬¸ì œ ìˆ˜ì‹  (DB ë¬¸ì œ)
            else if (data.questionText) {
                document.getElementById('quizTimer').innerText = "GO!";
                // ì„œë²„ ë¬¸ì œ í…ìŠ¤íŠ¸ í‘œì‹œ
                document.getElementById('quizQuestion').innerHTML = data.questionText;

                console.log(`[DEBUG_TIMER] questionDuration: ${questionDuration}`); // í˜„ì¬ ì „ì—­ ë³€ìˆ˜ ê°’
    console.log(`[DEBUG_TIMER] Server Time Limit in Payload: ${data.timeLimit}`); // ì„œë²„ê°€ ë³´ë‚¸ ê°’

                const clientDuration = data.timeLimit || questionDuration;
                // íƒ€ì´ë¨¸ ì¬ì‹œì‘ (ì •ë‹µ ì…ë ¥ í™œì„±í™”)
                startTimerDisplay(clientDuration, onQuestionTimerEnd);
            }
            // âœ¨ ì •ë‹µ ì—¬ë¶€ í”¼ë“œë°± (ì„œë²„ê°€ ë³´ë‚´ì¤€ë‹¤ê³  ê°€ì • - êµ¬í˜„ í•„ìš” ì‹œ ì„œë²„ ìˆ˜ì •)
            else if (data.type === 'ANSWER_RESULT') {
                 if (data.isCorrect) {
                     displayMessage({ sender: '[ì•Œë¦¼]', text: `ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! (+${data.score}ì )` });
                 } else {
                     displayMessage({ sender: '[ì•Œë¦¼]', text: `âŒ í‹€ë ¸ìŠµë‹ˆë‹¤.` });
                 }
            }
            // âœ¨ ê²Œì„ ì¢…ë£Œ
            else if (data.type === 'GAME_END') {
                    // â­â­ [í•„ìˆ˜ ìˆ˜ì •] ì„œë²„ê°€ ë³´ë‚¸ ìµœì¢… ë­í‚¹ ë°ì´í„°ë¥¼ ë¬´ì¡°ê±´ ì €ì¥
                 if (data.finalRanking) {
                     // ì„œë²„ì—ì„œ ë°›ì€ í™•ì •ëœ ë­í‚¹ ë°ì´í„°ë¡œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.
                     sessionStorage.setItem('participants', JSON.stringify(data.finalRanking));
                     console.log("âœ… [GAME END] ì„œë²„ ìµœì¢… ë­í‚¹ ë°ì´í„° ì €ì¥ ì™„ë£Œ.");
                 } else {
                     console.error("ğŸš¨ [GAME END] ìµœì¢… ë­í‚¹ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                 }
                 endGame();
            }
        };
    }

    // 10ì´ˆ ëŒ€ê¸° íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì‹¤í–‰
    function onInitialDelayEnd() {
        document.getElementById('quizTimer').innerText = "WAITING...";
        document.getElementById('quizQuestion').innerText = "ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    }

    // ë¬¸ì œ íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì‹¤í–‰
    function onQuestionTimerEnd() {
        document.getElementById('quizTimer').innerText = "TIME UP!";
        document.getElementById('quizQuestion').innerText = "ì‹œê°„ ì¢…ë£Œ! ë‹¤ìŒ ë¬¸ì œ ì¤€ë¹„ ì¤‘...";
        document.getElementById('ansInput').disabled = true; // ì‹œê°„ ì¢…ë£Œ ì‹œ ì…ë ¥ ë¶ˆê°€
    }

    // íƒ€ì´ë¨¸ í•¨ìˆ˜
    function startTimerDisplay(durationSeconds, onTimerEnd) {
        if (currentTimer) {
            clearInterval(currentTimer);
        }

        timeLeft = durationSeconds;
        const timerElement = document.getElementById('quizTimer');

        if(onTimerEnd === onQuestionTimerEnd) {
            timerElement.style.color = '#f1c40f';
            document.getElementById('ansInput').disabled = false; // ë¬¸ì œ ì‹œì‘ ì‹œ ì…ë ¥ í™œì„±í™”
            document.getElementById('ansInput').focus();
        }

        currentTimer = setInterval(() => {
            timerElement.innerText = timeLeft > 0 ? timeLeft : 0;

            if (timeLeft <= 0) {
                clearInterval(currentTimer);
                currentTimer = null;
                onTimerEnd();
                return;
            }

            timeLeft--;
        }, 1000);
    }

    // ê²Œì„ ì¢…ë£Œ
    function endGame() {
        document.getElementById('quizTimer').innerText = "END";
        document.getElementById('quizQuestion').innerHTML = "<h2>GAME OVER</h2>ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì ì‹œ í›„ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.";
        document.getElementById('ansInput').style.display = 'none';

        setTimeout(() => {
            location.href = 'result.html';
        }, 3000);
    }

    // ì°¸ê°€ì ëª©ë¡ ë° ì ìˆ˜ ì—…ë°ì´íŠ¸ (ì„œë²„ ë°ì´í„° ê¸°ë°˜)
    function updateParticipants(participants) {
        if (!participants) participants = [];

        // ì„¸ì…˜ ì €ì¥ (ê²°ê³¼ í˜ì´ì§€ìš©)
        sessionStorage.setItem('participants', JSON.stringify(participants));

        let listContainer = document.getElementById('p-list');
        const wrapper = document.querySelector('.participant-area');

        if (!listContainer) {
            if (wrapper) {
                listContainer = document.createElement('div');
                listContainer.id = 'p-list';
                wrapper.appendChild(listContainer);
            } else return;
        }

        // ì¤‘ë³µ ì œê±°
        const uniqueParticipants = [];
        const names = new Set();
        participants.forEach(p => {
            if (p.nickname && !names.has(p.nickname)) {
                names.add(p.nickname);
                uniqueParticipants.push(p);
            }
        });

        document.getElementById('p-count').innerText = uniqueParticipants.length;
        listContainer.innerHTML = '';

        // ì ìˆ˜ìˆœ ì •ë ¬
        uniqueParticipants.sort((a, b) => b.score - a.score);

        uniqueParticipants.forEach(p => {
            const isMe = (p.nickname === myName);
            const div = document.createElement('div');
            div.style.padding = "10px";
            div.style.borderBottom = "1px solid #46627f";
            div.style.marginBottom = "5px";

            if (isMe) {
                div.style.backgroundColor = "rgba(241, 196, 15, 0.1)";
                div.style.borderLeft = "3px solid #f1c40f";
            }

            div.innerHTML = `
                <div style="font-weight: ${isMe ? 'bold' : 'normal'}; color: ${isMe ? '#f1c40f' : '#ecf0f1'};">
                    ${p.nickname} ${isMe ? '(ë‚˜)' : ''}
                </div>
                <div style="font-size: 0.85rem; color: #bdc3c7;">
                    Score: ${p.score}
                </div>
            `;
            listContainer.appendChild(div);
        });
    }

    function displayMessage(msg) {
        const chatBox = document.getElementById("chatBox");
        // ... (ê¸°ì¡´ê³¼ ë™ì¼) ...
        if (msg.sender === '[ì•Œë¦¼]') {
            chatBox.innerHTML += `<div class="system-msg"><span class="system-badge">${msg.text}</span></div>`;
        } else {
            const isMe = msg.sender === myName;
            const cls = isMe ? "me" : "you";
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const nameHtml = isMe ? '' : `<span class="sender-name">${msg.sender}</span>`;

            chatBox.innerHTML += `
                <div style="clear:both;">
                    <div class="message ${cls}">
                        ${nameHtml}
                        <div>${msg.text}</div>
                        <small style="font-size:0.7rem; color:#ccc;">${time}</small>
                    </div>
                </div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const msg = input.value;
        if (msg.trim() === "") return;

        socket.send(JSON.stringify({ type: 'CHAT', sender: myName, text: msg, roomId: roomId }));
        displayMessage({ type: 'CHAT', sender: myName, text: msg });
        input.value = '';
    }

    function sendStartGame() {
        socket.send(JSON.stringify({ type: 'START', sender: myName, roomId: roomId }));
    }

    // âœ¨ ì •ë‹µ ì œì¶œ ë¡œì§ (ì„œë²„ë¡œë§Œ ì „ì†¡, ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜ ì œê±°)
    function sendAnswer(inputElement) {
        const answer = inputElement.value.trim();
        // ë¹„í™œì„±í™” ìƒíƒœê±°ë‚˜ ë‹µì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
        if(!answer || document.getElementById('ansInput').disabled) return;

        // 1. ì„œë²„ë¡œ ì •ë‹µ ì „ì†¡
        socket.send(JSON.stringify({ type: 'ANSWER', sender: myName, text: answer, roomId: roomId }));

        // 2. ì…ë ¥ì°½ ë¹„ìš°ê¸° (ì¤‘ë³µ ì œì¶œ ë°©ì§€ëŠ” ì„ íƒ ì‚¬í•­)
        inputElement.value = '';

        // 3. í”¼ë“œë°±: "ì œì¶œë¨" ì •ë„ë§Œ í‘œì‹œí•˜ê±°ë‚˜, ì„œë²„ ì‘ë‹µ(ANSWER_RESULT)ì„ ê¸°ë‹¤ë¦¼
        // í˜„ì¬ëŠ” ì„œë²„ê°€ ì¦‰ë‹µì„ ì•ˆ ì£¼ë¯€ë¡œ ì„ì‹œ í‘œì‹œ
        displayMessage({ sender: '[ì•Œë¦¼]', text: `ë‹µì•ˆ ì œì¶œ: ${answer}` });
    }
</script>
</body>
</html>